<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="./css/style.css" />
	<link rel="stylesheet" href="./css/SalasFunciones.css" />
	<link rel="icon" href="https://cinexunidos-production.up.railway.app/assets/images/cinex-unidos.png" />
	<title>Butacas</title>
</head>

<body>
	<header id="header"></header>
	<br>
	<aside id="aside"></aside>
	<script type="module">
		import {insertarHeader, insertarAside} from './src/js/mainAside.js';
		insertarHeader();
		insertarAside();
	</script>
	<hr />
	<main class="reserve-aside-space">
		<hgroup>
				<h1 id="deCine">Catálogo de películas</h1>
				<img id="imagenCine" src="https://cinexunidos-production.up.railway.app/assets/images/cinex-unidos.png" alt="imagen de cine" width="30%" />
			<h2>En cartelera</h2>
		</hgroup>
		<section id="SalasDeCine" class="movie-theater-list">
		</section>

	</main>
	<hr />
	<footer>
		<small> Necesitas ayuda? </small>
		<small> <a href="">contactenos</a> </small>
	</footer>

	<!-- #MARK:Inicio del artículo -->
	<article popover id="popupSala">
		<h2 id="nombreSala">Sala A6-41</h2>
		<p>La película inicia a las: <time id="start-time" datetime="PT4H18M3S"></time></p>
		<p>La película dura: <time id="runtime-movie" datetime="PT4H18M3S"></time></p>
		<p>Rating: <span id="rating"></span></p>
		<nav>
			<ul>

			</ul>
		</nav>

			<h7>
	</article>
	<!-- #MARK:fin del articulo -->
</body>
<script>
	const backendUrl = "https://cinexunidos-production.up.railway.app/"
	let url = window.location.href;
	function cargarPelicula(id, runtimeD, ratingD, teatros) {
		console.log(runtimeD);
		const popUp = document.getElementById("popupSala")
		const nombreSala = popUp.querySelector("#nombreSala")
		nombreSala.textContent = `Sala ${teatros[2]} en ${teatros[0]}`
		const startTime = popUp.querySelector("#start-time")
		const runtime = popUp.querySelector("#runtime-movie")
		const rating = popUp.querySelector("#rating")
		runtime.textContent = runtimeD
		numeroS = runtimeD.split(" ")[0]
		numero = parseInt(numeroS)
		horas = Math.floor(numero / 60)
		minutos = numero % 60
		console.log(teatros);
		runtime.setAttribute('datetime', `PT${horas}H${minutos}M0S`)
		startTime.textContent = teatros[3]

		rating.textContent = ratingD
		//agarrar el único hijo nav de popUp y agarrar su único hijo ul
		console.log(popUp);
		const nav = popUp.querySelector("nav")
		const ul = nav.querySelector("ul")
		console.log(id, runtimeD, ratingD, teatros);
		ul.innerHTML = ""
		//crear un li por cada teatro con un a que lleve a la página de ese teatro con la película
		const li = document.createElement("li")
		const a = document.createElement("a")
		a.href = `./butacas.html?theatre=${teatros[0]}&sala=${teatros[1]}&pelicula=${id}`
		a.textContent = `Ver en ${teatros[0]} en la sala ${teatros[1]}`
		li.appendChild(a)
		ul.appendChild(li)
	}

	const query = url.split("?")[1]
	let teatroId = query.split("&")[0]
	let peliId = query.split("&")[1]
	teatroId = teatroId.split("=")[1]
	peliId = peliId.split("=")[1]
	function cargarFuncionesPorTeatroYPelícula() {
		console.log(teatroId, peliId);
		console.log(`${backendUrl}theatres/${teatroId}/auditoriums`);
		const imagen = document.getElementById("imagenCine")
		const titulo = document.getElementById("deCine")
		fetch(`${backendUrl}theatres/${teatroId}/auditoriums`)
		.then(response => response.json())
		.then(data => {
			// imagen.src = backendUrl + data.images[1]
			titulo.textContent = titulo.textContent + " " + teatroId
			let salasDoc = document.getElementById("SalasDeCine")
			const ul = document.createElement("ul")
			ul.setAttribute("id", "cinesDisponibles")
			data.forEach(sala => {
				sala.showtimes.forEach(showtime => {
					if (peliId === (showtime.movie.id).toString()) {
						console.log("entré");
						const li = document.createElement("li")
						li.setAttribute("class", "card")
						const figure = document.createElement("figure")
						const img = document.createElement("img")
						const figcaption = document.createElement("figcaption")
						const button = document.createElement("button")
						img.src = backendUrl + showtime.movie.poster
						//haz la imagen más chiquita
						img.style.width = "25%";
	
						img.alt = `poster de ${showtime.movie.name}`
						figcaption.textContent = showtime.movie.name
						figure.setAttribute("class", "movie-poster")
						button.type = "button"
						button.setAttribute("popovertarget", "popupSala")
						button.setAttribute("popovertargetaction", "toggle")
						button.onclick = () => cargarPelicula(showtime.id, showtime.movie.runningTime, showtime.movie.rating, [teatroId, sala.id,sala.name,showtime.startTime])
						button.textContent = "Ver Detalles"
						figure.appendChild(img)
						figure.appendChild(figcaption)
						figure.appendChild(button)
						figure.id = showtime.movie.id
						li.appendChild(figure)
						ul.appendChild(li)
					}
				})
				
			})
			salasDoc.appendChild(ul)
		})
	}

	cargarFuncionesPorTeatroYPelícula()

</script>
<script type="text/javascript">
	function googleTranslateElementInit() {
		new google.translate.TranslateElement({
			pageLanguage: 'es',
			includedLanguages: 'es,en' // remove this line if you want to include all languages
		}, 'google_translate_element');
	}
</script>

<script type="text/javascript"
	src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</html>