<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="./css/SesionesSalas.css" />
	<link rel="icon" href="https://cinexunidos-production.up.railway.app/assets/images/cinex-unidos.png" />
	<title>Butacas</title>
</head>

<body>
	<header id="header"></header>
	<br>
	<aside id="aside"></aside>
	<script type="module" src="./src/js/mainAside.js"></script>
	<hr />
	<main class="reserve-aside-space">
		<hgroup>
				<h1 id="deCine">Catálogo de películas</h1>
				<img id="imagenCine" src="https://cinexunidos-production.up.railway.app/assets/images/cinex-unidos.png" alt="imagen de cine" width="30%" />
			<h2>En cartelera</h2>
		</hgroup>
		<section id="SalasDeCine">
		</section>
		<!-- <table role="presentation">
			<colgroup>
				<col style="border: 2px solid rgb(179, 30, 30)">
				<col span="7">
			</colgroup>
			<thead>
				<tr>
					<th scope="col">horas</th>
					<th scope="col">
						Lunes
					</th>
					<th scope="col">
						Martes
					</th>
					<th scope="col">
						Miercoles
					</th>
					<th scope="col">
						Jueves
					</th>
					<th scope="col">
						Viernes
					</th>
					<th scope="col">
						Sabado
					</th>
					<th scope="col">
						Domingo
					</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<th role="rowheader">
						<time datetime="8:00">8 A.M.</time>
					</th>
					<td rowspan="3">
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 4</time></button>

					</td>
					<td rowspan="1">

					</td>
					<td rowspan="2">
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 5</time></button>
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 4</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="9:00">9 A.M.</time>
					</th>
					<td rowspan="2">
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 5</time></button>
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 4</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="10:00">10 A.M.</time>
					</th>
					<td rowspan="2">
					</td>
					<td rowspan="2">

					</td>
					<td rowspan="2">
					</td>
					<td rowspan="2">
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 5</time></button>
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 4</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="11:00">11 A.M.</time>
					</th>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="12:00">12 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="13:00">1 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="14:00">2 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="15:00">3 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="16:00">4 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="17:00">5 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="18:00">6 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="19:00">7 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
				</tr>
				<tr>
					<th role="rowheader">
						<time datetime="20:00">8 P.M.</time>
					</th>
					<td>
						<button popovertarget="popupSala"><time datetime="15:00">Sala 3</time></button>
					</td>
					<td></td>
					<td></td>
					<td></td>
					<td>
						<button popovertarget="popupSala"><time datetime="PT2H20M">Sala 5</time></button>
					</td>

				</tr>
			</tbody>
		</table> -->

	</main>
	<hr />
	<footer>
		<small> Necesitas ayuda? </small>
		<small> <a href="">contactenos</a> </small>
	</footer>

	<!-- #MARK:Inicio del artículo -->
	<article popover id="popupSala">
		<h2>Sala A6-41</h2>

		<h7><a href="./pago.html"> Comprar</a>
			<h7>
	</article>
	<!-- #MARK:fin del articulo -->
</body>
<script>
	const backendUrl = "https://cinexunidos-production.up.railway.app/"
	let url = window.location.href;
	function cargarPelicula(id, runtimeD, ratingD, teatros) {
		console.log(runtimeD);
		const popUp = document.getElementById("PopUp")
		const runtime = popUp.querySelector("#runtime-movie")
		const rating = popUp.querySelector("#rating")
		runtime.textContent = runtimeD
		numeroS = runtimeD.split(" ")[0]
		numero = parseInt(numeroS)
		horas = Math.floor(numero / 60)
		minutos = numero % 60
		console.log(teatros);
		runtime.setAttribute('datetime', `PT${horas}H${minutos}M0S`)
		rating.textContent = ratingD
		//agarrar el único hijo nav de popUp y agarrar su único hijo ul
		const nav = popUp.querySelector("nav")
		const ul = nav.querySelector("ul")
		console.log(id, runtimeD, ratingD, teatros);
		ul.innerHTML = ""
		//crear un li por cada teatro con un a que lleve a la página de ese teatro con la película
		teatros.forEach(teatro => {
			const li = document.createElement("li")
			const a = document.createElement("a")
			a.href = `./SesionesSalas.html?theatre=${teatro}&movie=${id}`
			a.textContent = `Ver en ${teatro}`
			li.appendChild(a)
			ul.appendChild(li)
		})
	}

	function cargarTodasLasascientos() {
		fetch(`${backendUrl}theatres`)
			.then(response => response.json())
			.then(data => {
				let peliculasUnicas = new Map();
				console.log(data);
				const salasDoc = document.getElementById("SalasDeCine")
				data.forEach(teatro => {
					teatro.auditoriums.forEach(sala => {
						sala.showtimes.forEach(showtime => {
							if (!peliculasUnicas.has(showtime.movie.id)) {
								peliculasUnicas.set(showtime.movie.id, { name: showtime.movie.name, poster: showtime.movie.poster, runningTime: showtime.movie.runningTime, rating: showtime.movie.rating, teatros: new Set([teatro.id]) })
							} else {
								peliculasUnicas.get(showtime.movie.id).teatros.add(teatro.id)
							}
						})
					})
				})
				for (const movie of peliculasUnicas) {
					console.log(movie[1]);
					const figure = document.createElement("figure")
					const img = document.createElement("img")
					const figcaption = document.createElement("figcaption")
					const button = document.createElement("button")
					console.log(movie[1].poster);
					img.src = backendUrl + movie[1].poster
					img.alt = `poster de ${movie[1].name}`
					figcaption.textContent = movie[1].name
					figure.setAttribute("class", "movie-poster")
					button.type = "button"
					button.setAttribute("popovertarget", "PopUp")
					button.setAttribute("popovertargetaction", "toggle")

					button.onclick = () => cargarPelicula(movie[0], movie[1].runningTime, movie[1].rating, movie[1].teatros)
					button.textContent = "Ver Detalles"
					figure.appendChild(img)
					figure.appendChild(figcaption)
					figure.appendChild(button)
					figure.id = movie[1].id
					salasDoc.appendChild(figure)

				}
			})
	}

	const query = url.split("?")[1]
	let teatroId = query.split("&")[0]
	let peliId = query.split("&")[1]
	teatroId = teatroId.split("=")[1]
	peliId = peliId.split("=")[1]
	function cargarFuncionesPorTeatroYPelícula() {
		console.log(teatroId, peliId);
		console.log(`${backendUrl}theatres/${teatroId}/auditoriums`);
		const imagen = document.getElementById("imagenCine")
		const titulo = document.getElementById("deCine")
		fetch(`${backendUrl}theatres/${teatroId}/auditoriums`)
			.then(response => response.json())
			.then(data => {
				// imagen.src = backendUrl + data.images[1]
				titulo.textContent = titulo.textContent + " " + teatroId
				let salasDoc = document.getElementById("SalasDeCine")
				console.log(salasDoc);
				console.log(data);
				let showtimes = data.map(sala => sala.showtimes)
				showtimes = showtimes.flat()

				showtimes.forEach(showtime => {
						if (peliId === (showtime.movie.id).toString()) {
							console.log("entré");
							const h1 = document.createElement("h1")
							h1.textContent = showtime.movie.name
							const a = document.createElement("a") 
							const figure = document.createElement("figure")
							const img = document.createElement("img")
							const figcaption = document.createElement("figcaption")
							const button = document.createElement("button")
							img.src = backendUrl + showtime.movie.poster
							img.alt = `poster de ${showtime.movie.name}`
							figcaption.textContent = showtime.movie.name
							figure.setAttribute("class", "movie-poster")
							button.type = "button"
							button.setAttribute("popovertarget", "popupSala")
							button.setAttribute("popovertargetaction", "toggle")
							button.onclick = () => cargarPelicula(showtime.movie.id, showtime.movie.runningTime, showtime.movie.rating, [url.split("=")[1]])
							button.textContent = "Ver Detalles"
							figure.appendChild(img)
							figure.appendChild(figcaption)
							figure.appendChild(button)
							figure.id = showtime.movie.id
							salasDoc.appendChild(figure)
						}
					})
			})
	}

	cargarFuncionesPorTeatroYPelícula()

</script>
<script type="text/javascript">
	function googleTranslateElementInit() {
		new google.translate.TranslateElement({
			pageLanguage: 'es',
			includedLanguages: 'es,en' // remove this line if you want to include all languages
		}, 'google_translate_element');
	}
</script>

<script type="text/javascript"
	src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</html>